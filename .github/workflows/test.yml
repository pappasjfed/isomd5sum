name: Test

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Set minimal default permissions
permissions:
  contents: read

jobs:
  build-linux-makefile:
    name: Build on Linux with Makefile
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: registry.fedoraproject.org/fedora:39
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          dnf install -y gcc popt-devel python3 python3-devel make xorriso
      - name: Build
        run: |
          make
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp checkisomd5 artifacts/
          cp implantisomd5 artifacts/
          cp checkisosha artifacts/
          cp implantisosha artifacts/
          cp COPYING artifacts/LICENSE.txt
          cp README artifacts/README.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-linux-makefile
          path: artifacts/
          retention-days: 30
  
  test-linux-makefile-md5:
    name: Test MD5 on Linux (Makefile build)
    runs-on: ubuntu-latest
    needs: build-linux-makefile
    permissions:
      contents: read
    container:
      image: registry.fedoraproject.org/fedora:39
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          dnf install -y popt python3 python3-devel xorriso make gcc
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-linux-makefile
          path: ./bin
      - name: Make executables runnable
        run: |
          chmod +x bin/checkisomd5 bin/implantisomd5 bin/checkisosha bin/implantisosha
      - name: Test executables exist
        run: |
          test -f bin/checkisomd5 || exit 1
          test -f bin/implantisomd5 || exit 1
          echo "✓ MD5 executables found"
      - name: Test MD5 help output
        run: |
          ./bin/checkisomd5 --help || true
          ./bin/implantisomd5 --help || true
          echo "✓ MD5 executables can run"
      - name: Run Python MD5 tests
        run: |
          # Copy executables to expected location for tests
          cp bin/checkisomd5 ./
          cp bin/implantisomd5 ./
          # Build Python module for testing
          make pyisomd5sum.so
          make test-md5

  test-linux-makefile-sha:
    name: Test SHA-256 on Linux (Makefile build)
    runs-on: ubuntu-latest
    needs: build-linux-makefile
    permissions:
      contents: read
    container:
      image: registry.fedoraproject.org/fedora:39
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          dnf install -y popt python3 python3-devel xorriso make gcc
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-linux-makefile
          path: ./bin
      - name: Make executables runnable
        run: |
          chmod +x bin/checkisomd5 bin/implantisomd5 bin/checkisosha bin/implantisosha
      - name: Test SHA executables exist
        run: |
          test -f bin/checkisosha || exit 1
          test -f bin/implantisosha || exit 1
          echo "✓ SHA executables found"
      - name: Test SHA help output
        run: |
          ./bin/checkisosha --help || true
          ./bin/implantisosha --help || true
          echo "✓ SHA executables can run"
      - name: Run SHA-256 tests
        run: |
          # Copy executables to expected location for tests
          cp bin/checkisomd5 ./
          cp bin/implantisomd5 ./
          cp bin/checkisosha ./
          cp bin/implantisosha ./
          make test-sha
  
  build-linux-cmake:
    name: Build on Linux with CMake
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libpopt-dev
      - name: Build
        run: |
          mkdir build
          cd build
          cmake ..
          make
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp build/checkisomd5 artifacts/
          cp build/implantisomd5 artifacts/
          cp build/checkisosha artifacts/ || echo "checkisosha not found"
          cp build/implantisosha artifacts/ || echo "implantisosha not found"
          cp COPYING artifacts/LICENSE.txt
          cp README artifacts/README.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-linux-cmake
          path: artifacts/
          retention-days: 30
  
  test-linux-cmake:
    name: Test on Linux (CMake build)
    runs-on: ubuntu-latest
    needs: build-linux-cmake
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpopt0 xorriso
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-linux-cmake
          path: ./bin
      - name: Make executables runnable
        run: |
          chmod +x bin/checkisomd5 bin/implantisomd5
          chmod +x bin/checkisosha bin/implantisosha || true
      - name: Test executables exist
        run: |
          test -f bin/checkisomd5 || exit 1
          test -f bin/implantisomd5 || exit 1
          echo "✓ Executables found"
      - name: Test help output
        run: |
          ./bin/checkisomd5 --help || true
          ./bin/implantisomd5 --help || true
          echo "✓ Executables can run"
      - name: Create test ISO
        run: |
          mkdir -p testdata
          echo "Hello from Linux CMake test" > testdata/test.txt
          xorriso -as mkisofs -o test.iso -V "TEST" -J -R testdata/
          echo "✓ Test ISO created"
      - name: Test MD5 ISO operations
        run: |
          # Test implanting MD5 checksum
          echo "Testing implantisomd5..."
          ./bin/implantisomd5 test.iso
          if [ $? -ne 0 ]; then
            echo "✗ Failed to implant MD5 checksum"
            exit 1
          fi
          echo "✓ MD5 checksum implanted successfully"
          
          # Test checking MD5 checksum
          echo "Testing checkisomd5..."
          ./bin/checkisomd5 --md5sumonly test.iso
          echo "✓ MD5 checksum verification executed"
      - name: Test SHA-256 ISO operations
        run: |
          # Create new ISO for SHA test
          xorriso -as mkisofs -o test-sha.iso -V "TEST-SHA" -J -R testdata/
          
          # Test implanting SHA-256 checksum
          echo "Testing implantisosha..."
          ./bin/implantisosha test-sha.iso || echo "⚠ implantisosha not available in this build"
          
          # Test checking SHA-256 checksum
          echo "Testing checkisosha..."
          ./bin/checkisosha --md5sumonly test-sha.iso 2>/dev/null || echo "⚠ checkisosha not available in this build"
          
          echo ""
          echo "All CMake tests completed! ✓"

  build-windows-cmake:
    name: Build on Windows with CMake
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up CMake
        uses: lukka/get-cmake@latest
      - name: Build
        run: |
          mkdir build
          cd build
          cmake ..
          cmake --build . --config Release
      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          cp build/Release/checkisomd5.exe artifacts/ || echo "checkisomd5.exe not found"
          cp build/Release/implantisomd5.exe artifacts/ || echo "implantisomd5.exe not found"
          cp build/Release/checkisosha.exe artifacts/ || echo "checkisosha.exe not found"
          cp build/Release/implantisosha.exe artifacts/ || echo "implantisosha.exe not found"
          cp COPYING artifacts/LICENSE.txt
          cp README artifacts/README.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-windows-cmake
          path: artifacts/
          retention-days: 30

  test-windows-cmake-md5:
    name: Test MD5 on Windows (CMake build)
    runs-on: windows-latest
    needs: build-windows-cmake
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-cmake
          path: ./bin
      - name: Test MD5 executables exist
        shell: pwsh
        run: |
          if (-not (Test-Path "bin\checkisomd5.exe")) {
            Write-Host "✗ checkisomd5.exe not found"
            exit 1
          }
          if (-not (Test-Path "bin\implantisomd5.exe")) {
            Write-Host "✗ implantisomd5.exe not found"
            exit 1
          }
          Write-Host "✓ MD5 executables found"
      - name: Test MD5 help output
        shell: pwsh
        run: |
          & .\bin\checkisomd5.exe --help 2>&1 | Out-Null
          & .\bin\implantisomd5.exe --help 2>&1 | Out-Null
          Write-Host "✓ MD5 executables can run"
      - name: Create and test MD5 ISO
        shell: pwsh
        run: |
          # Create test data
          New-Item -ItemType Directory -Force -Path testdata | Out-Null
          "Hello from Windows MD5 test" | Out-File -FilePath testdata\test.txt
          
          # Note: ISO creation on Windows requires additional tools
          # For now, we'll just verify the tools can show help
          Write-Host "✓ MD5 Windows executables validated"

  test-windows-cmake-sha:
    name: Test SHA-256 on Windows (CMake build)
    runs-on: windows-latest
    needs: build-windows-cmake
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-cmake
          path: ./bin
      - name: Test SHA executables exist
        shell: pwsh
        run: |
          if (Test-Path "bin\checkisosha.exe") {
            Write-Host "✓ checkisosha.exe found"
          } else {
            Write-Host "⚠ checkisosha.exe not found in this build"
          }
          if (Test-Path "bin\implantisosha.exe") {
            Write-Host "✓ implantisosha.exe found"
          } else {
            Write-Host "⚠ implantisosha.exe not found in this build"
          }
      - name: Test SHA help output
        shell: pwsh
        run: |
          if (Test-Path "bin\checkisosha.exe") {
            & .\bin\checkisosha.exe --help 2>&1 | Out-Null
            Write-Host "✓ checkisosha.exe can run"
          }
          if (Test-Path "bin\implantisosha.exe") {
            & .\bin\implantisosha.exe --help 2>&1 | Out-Null
            Write-Host "✓ implantisosha.exe can run"
          }
          Write-Host "✓ SHA-256 Windows executables validated"
