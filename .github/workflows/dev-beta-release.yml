name: Dev Branch Beta Release

on:
  pull_request:
    branches: [ dev ]
  push:
    branches: [ dev ]
  workflow_dispatch:

# Set minimal default permissions
permissions:
  contents: read

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: registry.fedoraproject.org/fedora:39
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          dnf install -y gcc popt-devel python3 python3-devel make xorriso
      - name: Build
        run: |
          make
      - name: Run tests
        run: |
          make test
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp checkisomd5 artifacts/
          cp implantisomd5 artifacts/
          cp COPYING artifacts/LICENSE.txt
          cp README artifacts/README.txt
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-linux-dev
          path: artifacts/
          retention-days: 30

  build-windows:
    name: Build Windows Executables
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up CMake
        uses: lukka/get-cmake@latest
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 ..
      
      - name: Build
        run: |
          cd build
          cmake --build . --config Release
      
      - name: Prepare artifacts
        run: |
          mkdir artifacts
          copy build\Release\checkisomd5.exe artifacts\
          copy build\Release\implantisomd5.exe artifacts\
          copy COPYING artifacts\LICENSE.txt
          copy README artifacts\README.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-windows-dev
          path: artifacts/
          retention-days: 30

  publish-beta-release:
    name: Publish Beta Release
    runs-on: ubuntu-latest
    needs: [build-and-test, build-windows]
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    permissions:
      contents: write  # Needed to create releases
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: isomd5sum-linux-dev
          path: ./release-linux
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: isomd5sum-windows-dev
          path: ./release-windows
      
      - name: Generate version info
        id: version
        run: |
          # Generate beta version with timestamp
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          VERSION="beta-${TIMESTAMP}-${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"
      
      - name: Create release archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create Linux x64 archives (both tarball and zip)
          cd release-linux
          tar -czf ../isomd5sum-${VERSION}-linux-x64.tar.gz .
          zip -r ../isomd5sum-${VERSION}-linux-x64.zip .
          cd ..
          
          # Create Windows x64 zip
          cd release-windows
          zip -r ../isomd5sum-${VERSION}-windows-x64.zip .
          cd ..
          
          # Calculate checksums
          sha256sum isomd5sum-${VERSION}-linux-x64.tar.gz > checksums.txt
          sha256sum isomd5sum-${VERSION}-linux-x64.zip >> checksums.txt
          sha256sum isomd5sum-${VERSION}-windows-x64.zip >> checksums.txt
      
      - name: Create Beta Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Beta Release ${{ steps.version.outputs.version }}"
          files: |
            isomd5sum-*.tar.gz
            isomd5sum-*.zip
            checksums.txt
          body: |
            ## ⚠️ Beta Release (Dev Branch)
            
            This is an **automated beta release** from the `dev` branch.
            
            **⚠️ Warning**: This is a development build and may be unstable. Use at your own risk!
            
            ### Build Information
            - **Branch**: dev
            - **Commit**: ${{ github.sha }}
            - **Build Date**: ${{ steps.version.outputs.version }}
            
            ### Downloads
            - **Linux x64 Build**: 
              - `isomd5sum-*-linux-x64.tar.gz` - Tarball format (Built on Fedora 39)
              - `isomd5sum-*-linux-x64.zip` - Zip format (Built on Fedora 39)
            - **Windows x64 Build**: 
              - `isomd5sum-*-windows-x64.zip` - Built with Visual Studio 2022
            
            ### What's included
            - `checkisomd5` / `checkisomd5.exe` - Check MD5 checksums embedded in ISO images
            - `implantisomd5` / `implantisomd5.exe` - Implant MD5 checksums into ISO images
            - Documentation files
            
            ### Checksums
            See `checksums.txt` for SHA256 checksums of the release files.
            
            ---
            
            For stable releases, see releases tagged with version numbers (e.g., v1.0.0).
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
