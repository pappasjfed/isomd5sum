name: Windows Build and Release

on:
  push:
    branches: [ master, develop, dev ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, dev ]
  workflow_dispatch:

# Set minimal default permissions
permissions:
  contents: read

jobs:
  build-windows:
    name: Build Windows Executables
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up CMake
        uses: lukka/get-cmake@latest
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 ..
      
      - name: Build
        run: |
          cd build
          cmake --build . --config Release
      
      - name: Prepare artifacts
        run: |
          mkdir artifacts
          copy build\Release\checkisomd5.exe artifacts\
          copy build\Release\implantisomd5.exe artifacts\
          copy COPYING artifacts\LICENSE.txt
          copy README artifacts\README.txt
          copy WINDOWS_BUILD.md artifacts\WINDOWS_BUILD.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-windows-x64
          path: artifacts/
          retention-days: 30
  
  test-windows:
    name: Test Windows Executables
    runs-on: windows-latest
    needs: build-windows
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Checkout test assets from develop branch
        run: |
          git fetch origin develop
          git checkout origin/develop -- test/
          Write-Host "✓ Test assets retrieved"
      
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-x64
          path: ./bin
      
      - name: Test executables exist
        run: |
          if (!(Test-Path "bin\checkisomd5.exe")) { exit 1 }
          if (!(Test-Path "bin\implantisomd5.exe")) { exit 1 }
          Write-Host "✓ Executables found"
      
      - name: Test help output
        run: |
          cd bin
          # Note: --help returns exit code 1, which is fine
          $output = .\checkisomd5.exe --help 2>&1 | Out-String
          Write-Host "checkisomd5 --help output:"
          Write-Host $output
          Write-Host "Exit code: $LASTEXITCODE"
          Write-Host "✓ checkisomd5 can run"
          
          $output = .\implantisomd5.exe --help 2>&1 | Out-String
          Write-Host "implantisomd5 --help output:"
          Write-Host $output
          Write-Host "Exit code: $LASTEXITCODE"
          Write-Host "✓ implantisomd5 can run"
          
          # Reset exit code for next steps
          exit 0
      
      - name: Test with known good ISO (md5sumonly)
        run: |
          Write-Host "Testing checkisomd5 --md5sumonly with test.iso..."
          Write-Host "Expected MD5: a55e6ed72193ac49c96fa22599abe142"
          Write-Host ""
          
          $output = .\bin\checkisomd5.exe --md5sumonly .\test\test.iso 2>&1 | Out-String
          Write-Host "Output received:"
          Write-Host $output
          Write-Host "Exit code: $LASTEXITCODE"
          
          if ($output -match "a55e6ed72193ac49c96fa22599abe142") {
              Write-Host "✓ MD5 checksum displayed correctly"
          } else {
              Write-Host "✗ MD5 checksum NOT found in output"
              Write-Host "This indicates the output is not being captured or displayed"
              exit 1
          }
      
      - name: Test with known good ISO (full check with verbose)
        run: |
          Write-Host "Testing checkisomd5 --verbose with test.iso..."
          Write-Host ""
          
          # Use Start-Process to capture all output properly
          $output = & .\bin\checkisomd5.exe --verbose .\test\test.iso 2>&1 | Out-String
          Write-Host "Output received:"
          Write-Host $output
          Write-Host "Exit code: $LASTEXITCODE"
          
          if ($output -match "PASS|FAIL|complete") {
              Write-Host "✓ Media check result displayed"
          } else {
              Write-Host "✗ Media check result NOT found in output"
              Write-Host "This is the bug we need to fix!"
              exit 1
          }
      
      - name: Test full check (non-verbose)
        run: |
          Write-Host "Testing checkisomd5 (normal mode) with test.iso..."
          Write-Host ""
          
          $output = & .\bin\checkisomd5.exe .\test\test.iso 2>&1 | Out-String
          Write-Host "Output received:"
          Write-Host $output
          Write-Host "Exit code: $LASTEXITCODE"
          
          if ($output -match "PASS|FAIL|complete") {
              Write-Host "✓ Media check result displayed in normal mode"
          } else {
              Write-Host "✗ Media check result NOT found in output in normal mode"
              Write-Host "This confirms the Windows output bug"
              exit 1
          }
      
      - name: Summary
        if: always()
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "Test Summary"
          Write-Host "=========================================="
          Write-Host "If tests failed, the Windows output bug is confirmed"
          Write-Host "The program runs but doesn't display final results"
  
  build-mingw:
    name: Build with MinGW (Cross-compile)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install MinGW
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 cmake
      
      - name: Build with MinGW
        run: |
          mkdir build-mingw
          cd build-mingw
          cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/mingw-w64.cmake ..
          make
      
      - name: Check executables
        run: |
          file build-mingw/checkisomd5.exe
          file build-mingw/implantisomd5.exe
      
      - name: Prepare MinGW artifacts
        run: |
          mkdir artifacts-mingw
          cp build-mingw/checkisomd5.exe artifacts-mingw/
          cp build-mingw/implantisomd5.exe artifacts-mingw/
          cp COPYING artifacts-mingw/LICENSE.txt
          cp README artifacts-mingw/README.txt
          cp WINDOWS_BUILD.md artifacts-mingw/WINDOWS_BUILD.txt
      
      - name: Upload MinGW artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isomd5sum-windows-x64-mingw
          path: artifacts-mingw/
          retention-days: 30
  
  create-release:
    name: Create Windows Release
    runs-on: ubuntu-latest
    needs: [build-windows, test-windows, build-mingw]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write  # Needed to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download MSVC artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-x64
          path: ./release-msvc
      
      - name: Download MinGW artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-x64-mingw
          path: ./release-mingw
      
      - name: Create release archives
        run: |
          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Create MSVC zip
          cd release-msvc
          zip -r ../isomd5sum-${VERSION}-windows-x64-msvc.zip .
          cd ..
          
          # Create MinGW zip
          cd release-mingw
          zip -r ../isomd5sum-${VERSION}-windows-x64-mingw.zip .
          cd ..
          
          # Calculate checksums
          sha256sum isomd5sum-${VERSION}-windows-x64-msvc.zip > checksums.txt
          sha256sum isomd5sum-${VERSION}-windows-x64-mingw.zip >> checksums.txt
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            isomd5sum-*.zip
            checksums.txt
          body: |
            ## Windows Binaries
            
            This release includes pre-built Windows executables for isomd5sum tools.
            
            ### Downloads
            - **MSVC Build** (`isomd5sum-*-windows-x64-msvc.zip`): Built with Visual Studio 2022
            - **MinGW Build** (`isomd5sum-*-windows-x64-mingw.zip`): Built with MinGW-w64 (may have better compatibility with some systems)
            
            ### What's included
            - `checkisomd5.exe` - Check MD5 checksums embedded in ISO images
            - `implantisomd5.exe` - Implant MD5 checksums into ISO images
            - Documentation files
            
            ### Usage
            See `WINDOWS_BUILD.txt` included in the archive for detailed usage instructions.
            
            ### Checksums
            See `checksums.txt` for SHA256 checksums of the release files.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  create-prerelease:
    name: Create Pre-release (Develop Branch)
    runs-on: ubuntu-latest
    needs: [build-windows, test-windows, build-mingw]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    permissions:
      contents: write  # Needed to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download MSVC artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-x64
          path: ./release-msvc
      
      - name: Download MinGW artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          name: isomd5sum-windows-x64-mingw
          path: ./release-mingw
      
      - name: Generate version info
        id: version
        run: |
          # Generate beta version with timestamp
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          VERSION="beta-${TIMESTAMP}-${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"
      
      - name: Create release archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create MSVC zip
          cd release-msvc
          zip -r ../isomd5sum-${VERSION}-windows-x64-msvc.zip .
          cd ..
          
          # Create MinGW zip
          cd release-mingw
          zip -r ../isomd5sum-${VERSION}-windows-x64-mingw.zip .
          cd ..
          
          # Calculate checksums
          sha256sum isomd5sum-${VERSION}-windows-x64-msvc.zip > checksums.txt
          sha256sum isomd5sum-${VERSION}-windows-x64-mingw.zip >> checksums.txt
      
      - name: Create Pre-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Pre-release ${{ steps.version.outputs.version }}"
          files: |
            isomd5sum-*.zip
            checksums.txt
          body: |
            ## ⚠️ Pre-release / Beta Build
            
            This is an **automated pre-release** from the `develop` branch.
            
            **⚠️ Warning**: This is a development build and may be unstable. Use at your own risk!
            
            ### Build Information
            - **Branch**: develop
            - **Commit**: ${{ github.sha }}
            - **Build Date**: ${{ steps.version.outputs.version }}
            
            ### Downloads
            - **MSVC Build** (`isomd5sum-*-windows-x64-msvc.zip`): Built with Visual Studio 2022
            - **MinGW Build** (`isomd5sum-*-windows-x64-mingw.zip`): Built with MinGW-w64
            
            ### What's included
            - `checkisomd5.exe` - Check MD5 checksums embedded in ISO images
            - `implantisomd5.exe` - Implant MD5 checksums into ISO images
            - Documentation files
            
            ### Usage
            See `WINDOWS_BUILD.txt` included in the archive for detailed usage instructions.
            
            ### Checksums
            See `checksums.txt` for SHA256 checksums of the release files.
            
            ---
            
            For stable releases, see releases tagged with version numbers (e.g., v1.0.0).
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
